<!DOCTYPE html>
<html>
<head>
    <title>Simulador de Controle</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        .header { background: #f4f4f4; padding: 10px; text-align: center; }
        label { display: block; margin-top: 8px; }
        .section { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <a href="/">P√°gina Principal</a> | <a href="/pagina2">P√°gina 2</a>| <a href="/pagina3">P√°gina 3</a> | <a href="/pagina4">P√°gina 4</a> 
        
    </div>

    <h1>üõ†Ô∏è Simulador de Controle (Flask)</h1>

    <div class="section">
        <label>Tipo da Planta:</label>
        <select id="tipo" onchange="atualizarCampos()">
            <option value="Caso 1">Caso 1</option>
            <option value="Caso 2">Caso 2</option>
        </select>
    </div>

    <div id="caso1" class="section" style="display: none;">
        <label>Polo:</label>
        <input type="range" id="p1_1" min="-10" max="10" step="0.1" value="-1" oninput="sincronizarValor('p1_1', 'p1_1_num', this.value)">
        <input type="number" id="p1_1_num" min="-10" max="10" step="0.1" value="-1" oninput="sincronizarValor('p1_1', 'p1_1_num', this.value)">

        <label>Zero:</label>
        <input type="range" id="z_1" min="-10" max="10" step="0.1" value="0" oninput="sincronizarValor('z_1', 'z_1_num', this.value)">
        <input type="number" id="z_1_num" min="-10" max="10" step="0.1" value="0" oninput="sincronizarValor('z_1', 'z_1_num', this.value)">
    </div>

    <div id="caso2" class="section" style="display: none;">
        <label>Polo 1:</label>
        <input type="range" id="p1_2" min="-10" max="10" step="0.1" value="-1" oninput="sincronizarValor('p1_2', 'p1_2_num', this.value)">
        <input type="number" id="p1_2_num" min="-10" max="10" step="0.1" value="-1" oninput="sincronizarValor('p1_2', 'p1_2_num', this.value)">

        <label>Polo 2:</label>
        <input type="range" id="p2_2" min="-10" max="10" step="0.1" value="-2" oninput="sincronizarValor('p2_2', 'p2_2_num', this.value)">
        <input type="number" id="p2_2_num" min="-10" max="10" step="0.1" value="-2" oninput="sincronizarValor('p2_2', 'p2_2_num', this.value)">

        <label>Zero:</label>
        <input type="range" id="z_2" min="-10" max="10" step="0.1" value="0" oninput="sincronizarValor('z_2', 'z_2_num', this.value)">
        <input type="number" id="z_2_num" min="-10" max="10" step="0.1" value="0" oninput="sincronizarValor('z_2', 'z_2_num', this.value)">
    </div>

    <div class="section">
        <h3>Par√¢metros do Controlador</h3>
        <label>Polo do Controlador:</label>
        <input type="range" id="polo_controlador" min="-10" max="10" step="0.1" value="-1" oninput="sincronizarValor('polo_controlador', 'polo_controlador_num', this.value)">
        <input type="number" id="polo_controlador_num" min="-10" max="10" step="0.1" value="-1" oninput="sincronizarValor('polo_controlador', 'polo_controlador_num', this.value)">

        <label>Zero do Controlador:</label>
        <input type="range" id="zero_controlador" min="-10" max="10" step="0.1" value="0" oninput="sincronizarValor('zero_controlador', 'zero_controlador_num', this.value)">
        <input type="number" id="zero_controlador_num" min="-10" max="10" step="0.1" value="0" oninput="sincronizarValor('zero_controlador', 'zero_controlador_num', this.value)">
    </div>

    <div class="section">
        <h3>Perturba√ß√£o</h3>
        <label>Tempo da Perturba√ß√£o:</label>
        <input type="range" id="t_perturb" min="0" max="50" step="0.1" value="20" oninput="sincronizarValor('t_perturb', 't_perturb_num', this.value)">
        <input type="number" id="t_perturb_num" min="0" max="50" step="0.1" value="20" oninput="sincronizarValor('t_perturb', 't_perturb_num', this.value)">
        <label>Amplitude da Perturba√ß√£o:</label>
        <input type="range" id="amp_perturb" min="-2" max="2" step="0.01" value="0.5" oninput="sincronizarValor('amp_perturb', 'amp_perturb_num', this.value)">
        <input type="number" id="amp_perturb_num" min="-2" max="2" step="0.01" value="0.5" oninput="sincronizarValor('amp_perturb', 'amp_perturb_num', this.value)">
    </div>

    <div class="section">
        <h3>Perturba√ß√£o (arraste o ponto)</h3>
        <div id="slider2d" style="position: relative; width: 100%; max-width: 800px; height: 120px; background: #eee; border-radius: 8px; margin-bottom: 16px;">
            <div id="slider2d-point"
                style="position: absolute; width: 18px; height: 18px; border-radius: 50%; background: lime; border: 2px solid #333; cursor: grab;">
            </div>
            <span style="position:absolute; left:5px; top:0;">Tempo: <span id="slider2d-t"></span></span>
            <span style="position:absolute; right:5px; top:0;">Amplitude: <span id="slider2d-a"></span></span>
        </div>
    </div>

    <div class="section">
        <h3>Fun√ß√µes de Transfer√™ncia</h3>
        <div id="latex_planta" style="font-size: 1.2em; background: #eee; padding: 10px;"></div>
        <div id="latex_controlador" style="font-size: 1.2em; background: #eee; padding: 10px;"></div>
        <div id="latex_open" style="font-size: 1.2em; background: #eee; padding: 10px;"></div>
        <div id="latex_closed" style="font-size: 1.2em; background: #eee; padding: 10px;"></div>
    </div>

    <div class="section">
        <h3>Gr√°ficos</h3>
        <div id="plot" style="width: 100%; max-width: 800px; height: 400px; max-width: 100%;"></div>
    </div>

    <script>
        async function atualizar() {
            const tipo = document.getElementById("tipo").value;
            const data = {
                tipo,
                p1_1: document.getElementById("p1_1")?.value || -1,
                z_1: document.getElementById("z_1")?.value || 0,
                p1_2: document.getElementById("p1_2")?.value || -1,
                p2_2: document.getElementById("p2_2")?.value || -2,
                z_2: document.getElementById("z_2")?.value || 0,
                t_perturb: document.getElementById("t_perturb")?.value || 20,
                amp_perturb: document.getElementById("amp_perturb")?.value || 0.5
            };
        
            const res = await fetch('/atualizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        
            const json = await res.json();
        
            // Atualiza fun√ß√µes de transfer√™ncia
            document.getElementById("latex_planta").innerHTML = json.latex_planta || "Erro ao carregar planta";
            document.getElementById("latex_controlador").innerHTML = json.latex_controlador || "Erro ao carregar controlador";
            document.getElementById("latex_open").innerHTML = json.latex_open || "Erro ao carregar malha aberta";
            document.getElementById("latex_closed").innerHTML = json.latex_closed || "Erro ao carregar malha fechada";
            if (window.MathJax) MathJax.typesetPromise();
        
            // Substitua a parte de atualizar gr√°ficos por:
            const plotDiv = document.getElementById("plot");
            const plotData = json.plot_data;

            const traceStep = {
                x: plotData.T,
                y: plotData.yout_step,
                mode: 'lines',
                name: 'Degrau'
            };
            const tracePerturb = {
                x: plotData.T,
                y: plotData.yout_perturb,
                mode: 'lines',
                name: 'Com Perturba√ß√£o',
                line: {color: 'green'}
            };
            const markerPerturb = {
                x: [plotData.t_perturb],
                y: [plotData.yout_perturb[plotData.T.findIndex(t => t >= plotData.t_perturb)]],
                mode: 'markers',
                marker: {color: 'lime', size: 14, symbol: 'circle'},
                name: 'Perturba√ß√£o',
                customdata: [plotData.amp_perturb],
                draggable: true // s√≥ para refer√™ncia, Plotly n√£o usa isso diretamente
            };

            Plotly.newPlot(plotDiv, [traceStep, tracePerturb, markerPerturb], {
                title: "Resposta ao Degrau (Malha Aberta)",
                xaxis: {title: "Tempo (s)"},
                yaxis: {title: "Amplitude"},
                dragmode: 'closest'
            });

            plotDiv.on('plotly_relayout', function(eventdata) {
                // Detecta se o usu√°rio moveu o marcador (x[2] e y[2])
                if (eventdata['x[2]'] !== undefined && eventdata['y[2]'] !== undefined) {
                    const novo_t = eventdata['x[2]'];
                    const nova_amp = eventdata['y[2]'];
                    // Atualize os inputs e envie para o backend
                    document.getElementById('t_perturb').value = novo_t;
                    document.getElementById('t_perturb_num').value = novo_t;
                    document.getElementById('amp_perturb').value = nova_amp;
                    document.getElementById('amp_perturb_num').value = nova_amp;
                    atualizar();
                }
            });

            plotDiv.on('plotly_click', function(eventdata) {
                // S√≥ move se clicar no gr√°fico (n√£o na legenda)
                if (eventdata.points && eventdata.points.length > 0) {
                    const novo_t = eventdata.points[0].x;
                    const nova_amp = eventdata.points[0].y;
                    // Atualiza os inputs
                    document.getElementById('t_perturb').value = novo_t;
                    document.getElementById('t_perturb_num').value = novo_t;
                    document.getElementById('amp_perturb').value = nova_amp;
                    document.getElementById('amp_perturb_num').value = nova_amp;
                    atualizar();
                }
            });
        }
    
        function atualizarCampos() {
            const tipo = document.getElementById("tipo").value;
            document.getElementById("caso1").style.display = tipo === "Caso 1" ? "block" : "none";
            document.getElementById("caso2").style.display = tipo === "Caso 2" ? "block" : "none";
            atualizar();
        }
    
        window.onload = () => {
            atualizarCampos();
    
            // Escuta os inputs para atualizar automaticamente
            document.querySelectorAll("input").forEach(input => {
                input.addEventListener("input", atualizar);
            });
        };

        function atualizarValor(id, valor) {
            document.getElementById(id).textContent = valor;
        }

        function sincronizarValor(sliderId, numberId, valor) {
            document.getElementById(sliderId).value = valor;
            document.getElementById(numberId).value = valor;
        }

        const slider2d = document.getElementById('slider2d');
        const point = document.getElementById('slider2d-point');
        const tLabel = document.getElementById('slider2d-t');
        const aLabel = document.getElementById('slider2d-a');

        // Defina os limites do slider
        const tMin = 0, tMax = 50;
        const aMin = -2, aMax = 2;
        const width = 800, height = 120; // igual ao slider2d

        // Inicial
        let t_perturb = 20, amp_perturb = 0.5;

        function getSlider2dSize() {
            const rect = slider2d.getBoundingClientRect();
            return { width: rect.width, height: 120 }; // altura fixa
        }

        // Atualiza posi√ß√£o do ponto e labels
        function updateSlider2d() {
            const { width, height } = getSlider2dSize();
            const x = ((t_perturb - tMin) / (tMax - tMin)) * (width - 18);
            const y = ((aMax - amp_perturb) / (aMax - aMin)) * (height - 18);
            point.style.left = x + "px";
            point.style.top = y + "px";
            tLabel.textContent = t_perturb.toFixed(2);
            aLabel.textContent = amp_perturb.toFixed(2);

            // Atualiza os inputs ocultos (para integra√ß√£o com o backend)
            document.getElementById('t_perturb').value = t_perturb;
            document.getElementById('t_perturb_num').value = t_perturb;
            document.getElementById('amp_perturb').value = amp_perturb;
            document.getElementById('amp_perturb_num').value = amp_perturb;
        }

        // Drag & drop
        let dragging = false;
        point.onmousedown = function(e) {
            dragging = true;
            document.body.style.userSelect = "none";
        };
        document.onmouseup = function() {
            dragging = false;
            document.body.style.userSelect = "";
        };
        document.onmousemove = function(e) {
            if (!dragging) return;
            const rect = slider2d.getBoundingClientRect();
            const width = rect.width, height = rect.height;
            let x = e.clientX - rect.left - 9;
            let y = e.clientY - rect.top - 9;
            x = Math.max(0, Math.min(x, width - 18));
            y = Math.max(0, Math.min(y, height - 18));
            t_perturb = tMin + (x / (width - 18)) * (tMax - tMin);
            amp_perturb = aMax - (y / (height - 18)) * (aMax - aMin);
            updateSlider2d();
            atualizar();
        };

        // Sincroniza se mudar por outros meios
        function setSlider2d(t, a) {
            t_perturb = Math.max(tMin, Math.min(t, tMax));
            amp_perturb = Math.max(aMin, Math.min(a, aMax));
            updateSlider2d();
        }
        window.setSlider2d = setSlider2d;

        // Inicializa
        updateSlider2d();

        window.addEventListener('resize', updateSlider2d);
    </script>
</body>
</html>
