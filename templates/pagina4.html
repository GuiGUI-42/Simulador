<!DOCTYPE html>
<html>
<head>
    <title>Simulador de Controle - Página 4</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
    <link rel="stylesheet" href="/static/css/slider-style.css">
    
</head>
<body>
    <!-- Menu de hambúrguer -->
    <div class="menu">
        <div class="menu-icon"></div>
        <div class="menu-icon"></div>
        <div class="menu-icon"></div>
        <div class="menu-content">
            <label>
                <input id="dark-mode-toggle" type="checkbox">
                Ativar Modo Escuro
            </label>
            <a href="/pagina2" class="menu-link">Malha Aberta</a>
            <button id="abrir-feedback" style="margin-top:10px;">Enviar Feedback</button>
        </div>
    </div>

    <!-- Seção Esquerda -->
    <div class="left-section">
        <div id="parametros-fixos">
            <h3>Ajuste de Parâmetros</h3>
            <!-- Seleção da Ordem do Sistema -->
            <div style="margin-bottom: 20px;">
                <label for="ordem-sistema">Ordem do Sistema:</label>
                <select id="ordem-sistema">
                    <option value="1">1ª Ordem</option>
                    <option value="2">2ª Ordem</option>
                    <option value="3">3ª Ordem</option>
                </select>
            </div>
            <div style="margin: 10px 0; display: flex; justify-content: space-between; width: 100%;">
                <label style="display: flex; align-items: center; flex: 1;">
                    <input type="checkbox" id="mostrar-malha-aberta" checked style="margin-right: 6px;">
                    Mostrar Resposta ao Degrau (Malha Aberta)
                </label>
                <label style="display: flex; align-items: center; flex: 1;">
                    <input type="checkbox" id="mostrar-pz" checked style="margin-right: 6px;">
                    Mostrar Diagrama de Polos e Zeros
                </label>
            </div>
            <div style="margin: 10px 0; display: flex; justify-content: space-between; width: 100%;">
                <label style="display: flex; align-items: center; flex: 1;">
                    <input type="checkbox" id="mostrar-bode" checked style="margin-right: 6px;">
                    Mostrar Diagrama de Bode
                </label>
                <label style="display: flex; align-items: center; flex: 1;">
                    <input type="checkbox" id="mostrar-nyquist" checked style="margin-right: 6px;">
                    Mostrar Diagrama de Nyquist
                </label>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <!-- Parâmetros da Planta -->
                <div style="width: 48%;">
                    <h4>Parâmetros da Planta</h4>
                    <div id="planta-sliders"></div>
                </div>
                <!-- Parâmetros do Controlador -->
                <div style="width: 48%;">
                    <h4>Parâmetros do Controlador</h4>
                    <div class="slider-container">
                        <label class="slider-label">
                            <span>Ganho do Controlador (K):</span>
                        </label>
                        <input id="ganho-controlador" type="range" min="-10" max="20" step="0.01" value="1">
                        <input id="ganho-controlador-input" type="number" min="0" max="10" step="0.01" value="1" style="width: 80px; margin-left: 10px;">
                    </div>
                    <div id="controlador-sliders"></div>
                </div>
            </div>
        </div>
        <h3>Funções de Transferência</h3>
        <div style="position: relative; margin-bottom: 16px;">
            <b>Planta:</b>
            <div id="latex_planta_fatorada" class="latex-container" style="transition: box-shadow 0.2s;">
                Carregando forma fatorada...
            </div>
            <!-- Seta para expandir -->
            <button id="seta-ft-planta" title="Mostrar/ocultar forma polinomial"
                style="
                    position: absolute;
                    right: 8px;
                    bottom: 8px;
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 1.5em;
                    color: #2196f3;
                    z-index: 10;
                    transition: color 0.2s;
                ">
                &#x25BC;
            </button>
            <div id="latex_planta_polinomial" class="latex-container" style="display: none;">
                Carregando forma polinomial...
            </div>
        </div>
        <!-- Substitua o bloco das FTs do controlador por este: -->
        <div style="position: relative; margin-bottom: 16px;">
            <b>Controlador:</b>
            <div id="latex_controlador_fatorada" class="latex-container" style="transition: box-shadow 0.2s;">
                Carregando forma fatorada...
            </div>
            <!-- Seta para expandir -->
            <button id="seta-ft-controlador" title="Mostrar/ocultar forma polinomial"
                style="
                    position: absolute;
                    right: 8px;
                    bottom: 8px;
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 1.5em;
                    color: #2196f3;
                    z-index: 10;
                    transition: color 0.2s;
                ">
                &#x25BC;
            </button>
            <div id="latex_controlador_polinomial" class="latex-container" style="display: none;">
                Carregando forma polinomial...
            </div>
        </div>
        <div class="section">
            <h3>Perturbação (Malha Fechada)</h3>
            <div id="slider2d-fechada" class="slider2d-box">
                <div id="slider2d-point-fechada"></div>
                <span class="slider2d-label slider2d-label-left">
                    Tempo:
                    <input id="input-t-fechada" type="number" min="0" max="50" step="0.01" style="width:60px; margin-left:6px;">
                </span>
                <span class="slider2d-label slider2d-label-right">
                    Amplitude:
                    <input id="input-a-fechada" type="number" min="-2" max="2" step="0.01" style="width:60px; margin-left:6px;">
                </span>
                <span class="slider2d-hint">Arraste o ponto laranja</span>
            </div>
        </div>
    </div>

    <!-- Seção Direita -->
    <div class="right-section">
        <h3>Gráficos</h3>
        <h4>Diagrama de Polos e Zeros</h4>
        <div id="plot_pz"></div>
        <div id="malha-aberta-container">
            <h4>Resposta ao Degrau (Malha Aberta)</h4>
            <div id="plot_open"></div>
        </div>
        <h4>Resposta ao Degrau (Malha Fechada)</h4>
        <div id="plot_closed"></div>
        <h4>Diagrama de Bode</h4>
        <div id="plot_bode"></div>
        <h4>Diagrama de Nyquist</h4>
        <div id="plot_nyquist"></div>
    </div>

    <div id="modal-feedback" class="modal">
        <div class="modal-content">
            <span class="close" id="fechar-modal">&times;</span>
            <h3>Envie seu Feedback</h3>
            <textarea id="feedback-texto" rows="6" style="width: 100%;" placeholder="Digite seu feedback aqui..."></textarea>
            <button id="enviar-feedback">Enviar</button>
        </div>
    </div>

    <script>
    function atualizarSliders() {
        const ordem = parseInt(document.getElementById("ordem-sistema").value);
        const plantaSliders = document.getElementById("planta-sliders");
        const controladorSliders = document.getElementById("controlador-sliders");
        plantaSliders.innerHTML = "";
        controladorSliders.innerHTML = "";
        for (let i = 1; i <= ordem; i++) {
            plantaSliders.innerHTML += `
                <div class="slider-container">
                    <label class="slider-label">
                        <span>Polo ${i} da Planta:</span>
                    </label>
                    <input id="polo-planta-${i}" type="range" min="-10" max="10" step="0.001" value="-1">
                    <input id="polo-planta-input-${i}" type="number" step="0.001" value="-1" style="width: 80px; margin-left: 10px;">
                </div>
                <div class="slider-container">
                    <label class="slider-label">
                        <span>Zero ${i} da Planta:</span>
                    </label>
                    <input id="zero-planta-${i}" type="range" min="-10" max="10" step="0.001" value="0">
                    <input id="zero-planta-input-${i}" type="number" step="0.001" value="0" style="width: 80px; margin-left: 10px;">
                </div>
            `;
            controladorSliders.innerHTML += `
                <div class="slider-container">
                    <label class="slider-label">
                        <span>Polo ${i} do Controlador:</span>
                    </label>
                    <input id="polo-controlador-${i}" type="range" min="-10" max="10" step="0.001" value="-1">
                    <input id="polo-controlador-input-${i}" type="number" step="0.001" value="-1" style="width: 80px; margin-left: 10px;">
                </div>
                <div class="slider-container">
                    <label class="slider-label">
                        <span>Zero ${i} do Controlador:</span>
                    </label>
                    <input id="zero-controlador-${i}" type="range" min="-10" max="10" step="0.001" value="0">
                    <input id="zero-controlador-input-${i}" type="number" step="0.001" value="0" style="width: 80px; margin-left: 10px;">
                </div>
            `;
        }
        adicionarEventosSliders(ordem);
    }

    function adicionarEventosSliders(ordem) {
        for (let i = 1; i <= ordem; i++) {
            // Planta
            let sliderP = document.getElementById(`polo-planta-${i}`);
            let inputP = document.getElementById(`polo-planta-input-${i}`);
            sliderP.addEventListener('input', () => {
                inputP.value = sliderP.value;
                atualizarTudo(); // <-- Troque para atualizarTudo
            });
            inputP.addEventListener('input', () => {
                sliderP.value = inputP.value;
                atualizarTudo();
            });
            let sliderZ = document.getElementById(`zero-planta-${i}`);
            let inputZ = document.getElementById(`zero-planta-input-${i}`);
            sliderZ.addEventListener('input', () => {
                inputZ.value = sliderZ.value;
                atualizarTudo();
            });
            inputZ.addEventListener('input', () => {
                sliderZ.value = inputZ.value;
                atualizarTudo();
            });
            // Controlador
            let sliderPC = document.getElementById(`polo-controlador-${i}`);
            let inputPC = document.getElementById(`polo-controlador-input-${i}`);
            sliderPC.addEventListener('input', () => {
                inputPC.value = sliderPC.value;
                atualizarTudo();
            });
            inputPC.addEventListener('input', () => {
                sliderPC.value = inputPC.value;
                atualizarTudo();
            });
            let sliderZC = document.getElementById(`zero-controlador-${i}`);
            let inputZC = document.getElementById(`zero-controlador-input-${i}`);
            sliderZC.addEventListener('input', () => {
                inputZC.value = sliderZC.value;
                atualizarTudo();
            });
            inputZC.addEventListener('input', () => {
                sliderZC.value = inputZC.value;
                atualizarTudo();
            });
        }
    }

    async function atualizar() {
        const ordem = parseInt(document.getElementById("ordem-sistema").value);
        const polosPlanta = [];
        const zerosPlanta = [];
        const polosControlador = [];
        const zerosControlador = [];
        const ganhoControlador = parseFloat(document.getElementById('ganho-controlador').value);
        for (let i = 1; i <= ordem; i++) {
            polosPlanta.push(parseFloat(document.getElementById(`polo-planta-${i}`).value));
            zerosPlanta.push(parseFloat(document.getElementById(`zero-planta-${i}`).value));
            polosControlador.push(parseFloat(document.getElementById(`polo-controlador-${i}`).value));
            zerosControlador.push(parseFloat(document.getElementById(`zero-controlador-${i}`).value));
        }
        const data = {
            ordem: ordem,
            polos_planta: polosPlanta,
            zeros_planta: zerosPlanta,
            polos_controlador: polosControlador,
            zeros_controlador: zerosControlador,
            ganho_controlador: ganhoControlador,
            t_perturb_fechada: t_perturb_fechada,           // <-- adicione isto
            amp_perturb_fechada: amp_perturb_fechada        // <-- adicione isto
        };
        const res = await fetch('/atualizar_pagina4', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const json = await res.json();
        document.getElementById("latex_planta_polinomial").innerHTML = json.latex_planta_polinomial || "Erro ao carregar forma polinomial";
        document.getElementById("latex_planta_fatorada").innerHTML = json.latex_planta_fatorada || "Erro ao carregar forma fatorada";
        document.getElementById("latex_controlador_polinomial").innerHTML = json.latex_controlador_polinomial || "Erro ao carregar forma polinomial";
        document.getElementById("latex_controlador_fatorada").innerHTML = json.latex_controlador_fatorada || "Erro ao carregar forma fatorada";
        if (window.MathJax) MathJax.typesetPromise();

        // Plota os gráficos com o layout e cores já enviados pelo backend
        Plotly.newPlot('plot_pz', json.plot_pz_data.data, json.plot_pz_data.layout);
        Plotly.newPlot('plot_open', json.plot_open_data.data, json.plot_open_data.layout);
        Plotly.newPlot('plot_closed', json.plot_closed_data.data, json.plot_closed_data.layout);

        // Mostra ou esconde conforme a caixa de seleção
        const mostrar = document.getElementById('mostrar-malha-aberta').checked;
        document.getElementById('plot_open').style.display = mostrar ? '' : 'none';
        document.getElementById('malha-aberta-container').style.display = mostrar ? '' : 'none';
    }

    async function atualizarBodeNyquist() {
        const ordem = parseInt(document.getElementById("ordem-sistema").value);
        const polosPlanta = [];
        const zerosPlanta = [];
        const polosControlador = [];
        const zerosControlador = [];
        const ganhoControlador = parseFloat(document.getElementById('ganho-controlador').value);

        for (let i = 1; i <= ordem; i++) {
            polosPlanta.push(parseFloat(document.getElementById(`polo-planta-${i}`).value));
            zerosPlanta.push(parseFloat(document.getElementById(`zero-planta-${i}`).value));
            polosControlador.push(parseFloat(document.getElementById(`polo-controlador-${i}`).value));
            zerosControlador.push(parseFloat(document.getElementById(`zero-controlador-${i}`).value));
        }

        const data = {
            ordem: ordem,
            polos_planta: polosPlanta,
            zeros_planta: zerosPlanta,
            polos_controlador: polosControlador,
            zeros_controlador: zerosControlador,
            ganho_controlador: ganhoControlador
        };

        // Bode
        const resBode = await fetch('/atualizar_bode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const bode = await resBode.json();
        Plotly.newPlot('plot_bode', bode.bode_data.data, bode.bode_data.layout);

        // Nyquist
        const resNyquist = await fetch('/atualizar_nyquist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const nyquist = await resNyquist.json();
        Plotly.newPlot('plot_nyquist', nyquist.nyquist_data.data, nyquist.nyquist_data.layout);
    }

    // Chame após atualizar()
    async function atualizarTudo() {
        await atualizar(); // Atualiza os gráficos de polos e zeros e resposta ao degrau
        await atualizarBodeNyquist(); // Atualiza os diagramas de Bode e Nyquist
    }

    // Troque window.onload e eventos para usar atualizarTudo:
    window.onload = () => {
        atualizarSliders();
        atualizarTudo();
        document.getElementById('plot_pz').style.display = document.getElementById('mostrar-pz').checked ? '' : 'none';
        document.getElementById('plot_bode').style.display = document.getElementById('mostrar-bode').checked ? '' : 'none';
        document.getElementById('plot_nyquist').style.display = document.getElementById('mostrar-nyquist').checked ? '' : 'none';
    };
    document.getElementById("ordem-sistema").addEventListener("change", () => {
        atualizarSliders();
        atualizarTudo();
    });

    // Mostra ou esconde o gráfico de malha aberta conforme a caixa de seleção
    document.getElementById('mostrar-malha-aberta').addEventListener('change', function() {
        const plotOpen = document.getElementById('plot_open');
        plotOpen.style.display = this.checked ? '' : 'none';
    });
    document.getElementById('mostrar-malha-aberta').addEventListener('change', function() {
        const container = document.getElementById('malha-aberta-container');
        container.style.display = this.checked ? '' : 'none';
    });

    document.getElementById('mostrar-pz').addEventListener('change', function() {
        document.getElementById('plot_pz').style.display = this.checked ? '' : 'none';
    });
    document.getElementById('mostrar-bode').addEventListener('change', function() {
        document.getElementById('plot_bode').style.display = this.checked ? '' : 'none';
    });
    document.getElementById('mostrar-nyquist').addEventListener('change', function() {
        document.getElementById('plot_nyquist').style.display = this.checked ? '' : 'none';
    });

    // Menu e modo escuro (mantém igual)
    const menu = document.querySelector('.menu');
    const menuContent = document.querySelector('.menu-content');

    menu.addEventListener('mouseenter', () => {
        menuContent.classList.add('show');
        menu.classList.add('open');
    });
    menu.addEventListener('mouseleave', () => {
        menuContent.classList.remove('show');
        menu.classList.remove('open');
    });

    document.getElementById('dark-mode-toggle').addEventListener('change', (event) => {
        document.body.classList.toggle('dark-mode', event.target.checked);
        atualizar(); // Redesenha os gráficos com o layout correto
    });

    // Feedback modal
    document.getElementById('abrir-feedback').onclick = function() {
        document.getElementById('modal-feedback').style.display = 'block';
    };
    document.getElementById('fechar-modal').onclick = function() {
        document.getElementById('modal-feedback').style.display = 'none';
    };
    window.onclick = function(event) {
        if (event.target == document.getElementById('modal-feedback')) {
            document.getElementById('modal-feedback').style.display = 'none';
        }
    };
    // Exemplo de envio (você pode adaptar para enviar ao backend)
    document.getElementById('enviar-feedback').onclick = async function() {
        const texto = document.getElementById('feedback-texto').value;
        const res = await fetch('/enviar_feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ feedback: texto })
        });
        if (res.ok) {
            alert('Feedback enviado com sucesso!');
            document.getElementById('modal-feedback').style.display = 'none';
            document.getElementById('feedback-texto').value = '';
        } else {
            alert('Erro ao enviar feedback.');
        }
    };

    // Após atualizarSliders() e adicionarEventosSliders()
    document.getElementById('ganho-controlador').addEventListener('input', function() {
        document.getElementById('ganho-controlador-input').value = this.value;
        atualizarTudo();
    });
    document.getElementById('ganho-controlador-input').addEventListener('input', function() {
        document.getElementById('ganho-controlador').value = this.value;
        atualizarTudo();
    });

    // --- Slider 2D para perturbação em malha fechada ---
    const slider2dFechada = document.getElementById('slider2d-fechada');
    const pointFechada = document.getElementById('slider2d-point-fechada');
    const tLabelFechada = document.getElementById('slider2d-t-fechada');
    const aLabelFechada = document.getElementById('slider2d-a-fechada');
    const inputTFechada = document.getElementById('input-t-fechada');
    const inputAFechada = document.getElementById('input-a-fechada');
    const tMinF = 0, tMaxF = 50;
    const aMinF = -2, aMaxF = 2;
    let t_perturb_fechada = 20, amp_perturb_fechada = 0.0;

    function getSlider2dFechadaSize() {
        const rect = slider2dFechada.getBoundingClientRect();
        return { width: rect.width, height: 120 };
    }

    function updateSlider2dFechada(updateInputs=true) {
        const { width, height } = getSlider2dFechadaSize();
        const x = ((t_perturb_fechada - tMinF) / (tMaxF - tMinF)) * (width - 18);
        const y = ((aMaxF - amp_perturb_fechada) / (aMaxF - aMinF)) * (height - 18);
        pointFechada.style.left = x + "px";
        pointFechada.style.top = y + "px";
        if(updateInputs) {
            inputTFechada.value = t_perturb_fechada.toFixed(2);
            inputAFechada.value = amp_perturb_fechada.toFixed(2);
        }
    }

    // Drag & drop
    let draggingFechada = false;
    pointFechada.onmousedown = function(e) {
        draggingFechada = true;
        document.body.style.userSelect = "none";
    };
    document.onmouseup = function() {
        draggingFechada = false;
        document.body.style.userSelect = "";
    };
    document.onmousemove = function(e) {
        if (!draggingFechada) return;
        const rect = slider2dFechada.getBoundingClientRect();
        const width = rect.width, height = rect.height;
        let x = e.clientX - rect.left - 9;
        let y = e.clientY - rect.top - 9;
        x = Math.max(0, Math.min(x, width - 18));
        y = Math.max(0, Math.min(y, height - 18));
        t_perturb_fechada = tMinF + (x / (width - 18)) * (tMaxF - tMinF);
        amp_perturb_fechada = aMaxF - (y / (height - 18)) * (aMaxF - aMinF);
        updateSlider2dFechada();
        atualizar();
    };

    // Inputs manuais
    inputTFechada.addEventListener('input', function() {
        let val = parseFloat(this.value);
        if (isNaN(val)) return;
        t_perturb_fechada = Math.max(tMinF, Math.min(val, tMaxF));
        updateSlider2dFechada(false);
        atualizar();
    });
    inputAFechada.addEventListener('input', function() {
        let val = parseFloat(this.value);
        if (isNaN(val)) return;
        amp_perturb_fechada = Math.max(aMinF, Math.min(val, aMaxF));
        updateSlider2dFechada(false);
        atualizar();
    });

    // Responsivo
    window.addEventListener('resize', () => updateSlider2dFechada());

    // Inicializa
    updateSlider2dFechada();

    // Adicione ao final do seu <script> ou após o updateSlider2dFechada()
    const setaFtPlanta = document.getElementById('seta-ft-planta');
    const polinomialDiv = document.getElementById('latex_planta_polinomial');
    let polinomialVisivel = false;

    setaFtPlanta.onclick = function() {
        polinomialVisivel = !polinomialVisivel;
        polinomialDiv.style.display = polinomialVisivel ? '' : 'none';
        setaFtPlanta.innerHTML = polinomialVisivel ? '&#x25B2;' : '&#x25BC;';
    };

    // Seta para expandir/recolher FT do controlador (agora fatorada é a principal)
    const setaFtControlador = document.getElementById('seta-ft-controlador');
    const fatoradaDivControlador = document.getElementById('latex_controlador_fatorada');
    const polinomialDivControlador = document.getElementById('latex_controlador_polinomial');
    let fatoradaVisivelControlador = false;

    setaFtControlador.onclick = function() {
        fatoradaVisivelControlador = !fatoradaVisivelControlador;
        polinomialDivControlador.style.display = fatoradaVisivelControlador ? '' : 'none';
        setaFtControlador.innerHTML = fatoradaVisivelControlador ? '&#x25B2;' : '&#x25BC;';
    };
    </script>
</body>
</html>